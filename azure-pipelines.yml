jobs:
- job: Linux
  pool:
    vmImage: 'Ubuntu 16.04'
  variables:
    FORCE_COLOR: 1
    JEST_DIR: $(Agent.BuildDirectory)/jest

  steps:
  - checkout: self
    fetchDepth: 1
  
  - task: NodeTool@0
    inputs:
      versionSpec: '10.x'
    displayName: 'Use Node.js 10'

  - task: UsePythonVersion@0
    inputs:
      versionSpec: '2.7'
    displayName: 'Use Python 2.7'

  - script: |
      cd /
      mv $(Build.Repository.LocalPath) $(JEST_DIR)
      mkdir -p $(Build.Repository.LocalPath) # this dir has to exist for some reason
    displayName: 'Create jest folder (workaround)'

  - script: |
      yarn
    displayName: 'Install dependencies'
    workingDirectory: $(JEST_DIR)

  - script: |
      yarn run test-ci-partial
    displayName: 'Run tests'
    workingDirectory: $(JEST_DIR)

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: '**/reports/junit/*.xml'
      searchFolder: $(JEST_DIR)
    displayName: 'Publish test results'

#- job: macOS
#  pool:
#    vmImage: 'macOS-10.13'
#  steps:
#  - task: NodeTool@0
#    inputs:
#      versionSpec: '10.x'
#    displayName: 'Install Node.js'
#  - script: |
#      yarn
#      yarn jest --color
#    displayName: 'install, build, and test'

- job: Windows
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '10.x'
    displayName: 'Install Node.js'

  - task: UsePythonVersion@0
    inputs:
      versionSpec: '2.7' 
      
  - script: |
      yarn
      yarn run test-ci-partial
    displayName: 'test'
    env:
      FORCE_COLOR: 1
